<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Coin Prices</title>
    <link rel="stylesheet" href="/css/styles.css">

<!--    ìº”ë“¤ì°¨íŠ¸ ê´€ë ¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

</head>
<body>
<div class="container">
    <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->

    <div id="notification-container" class="notification-container"></div>


    <div class="navbar">
        <div class="logo">ì½”ì¸ ì •ë³´</div>
        <button class="login-btn" onclick="redirectToLogin()">ë¡œê·¸ì¸</button>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="chart-area">
        <h2>ì½”ì¸ ì°¨íŠ¸</h2>
        <canvas id="coinChart" width="400" height="200"></canvas>
    </div>

    <!-- ìì‚° ëª©ë¡ -->
    <div class="asset-list">


        <h2>ê°€ìƒìì‚° ëª©ë¡</h2>

        <div class="filter-container">
            <button id="filter-all">ì „ì²´</button>
            <button id="filter-interest">ê´€ì‹¬</button>
            <button id="filter-owned">ë³´ìœ </button>
        </div>

        <table>
            <thead>
            <tr>
                <th data-key="subscription" class="sortable">êµ¬ë…</th> <!-- ì¶”ê°€ëœ ì»¬ëŸ¼ -->
                <th data-key="market" class="sortable">ê°€ìƒìì‚° ëª… <span class="sort-icon asc"></span><span
                        class="sort-icon desc"></span></th>
                <th data-key="currentPrice" class="sortable">ê°€ê²© <span class="sort-icon asc"></span><span
                        class="sort-icon desc"></span></th>
                <th data-key="changeRate" class="sortable">ë“±ë½ë¥  <span class="sort-icon asc"></span><span
                        class="sort-icon desc"></span></th>
                <th data-key="tradeVolume24h" class="sortable">ê±°ë˜ëŒ€ê¸ˆ <span class="sort-icon asc"></span><span
                        class="sort-icon desc"></span></th>
            </tr>
            </thead>
            <tbody id="coin-list">
            <!-- ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const coinList = document.getElementById("coin-list");
    let coinsData = []; // ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
    let subscribedMarkets = []; // APIì—ì„œ ë°›ì€ êµ¬ë… ë§ˆì¼“ ë¦¬ìŠ¤íŠ¸
    let previousPrices = {}; // ì´ì „ ê°€ê²©ì„ ì €ì¥
    let sortConfig = {key: "", direction: "asc"}; // í˜„ì¬ ì •ë ¬ ìƒíƒœ ì €ì¥
    let selectedCoin = "BTC/KRW"; // ê¸°ë³¸ ì„ íƒ ì½”ì¸
    let currentFilter = "all"; // í˜„ì¬ í•„í„° ìƒíƒœ: "all" ë˜ëŠ” "interest"

    let solarCoinsData = [];//ê¸‰ë“±ì½”ì¸ã…‡ì €ë³´


    // WebSocket ì—°ê²° ì„¤ì •
    const socket = new WebSocket("ws://localhost:8082/ws");

    socket.onopen = () => {
        console.log("WebSocket ì—°ê²° ì„±ê³µ!");
        socket.send("í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì†í–ˆìŠµë‹ˆë‹¤!");
    };

    socket.onclose = function () {
        console.log("WebSocket ì—°ê²° ì¢…ë£Œ");
    };

    socket.onerror = function (error) {
        console.error("WebSocket ì˜¤ë¥˜ ë°œìƒ:", error);
    }

    // ì›¹ì†Œì¼“ ë©”ì‹œì§€ ì²˜ë¦¬
    socket.onmessage = function (event) {
        try {
            const message = JSON.parse(event.data);

            console.log("ë©”ì‹œì§€ì„" ,message);
            // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
            switch (message.type) {
                //ì „ì²´ì½”ì¸ì •ë³´ë¥¼ ë³´ë‚¸ê²½ìš°
                case "all_coins":
                    handleAllCoins(message.data);
                    break;
                //ê¸‰ë“±ì½”ì¸ì •ë³´ë¥¼ ë³´ë‚¸ê²½ìš°
                case "surging_coins":
                    handlePriceSurge(message.data);
                    break;
                default:
                    console.warn("ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:", message.type);
            }
        } catch (error) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", error);
        }
    };







    // ì „ì²´ ì½”ì¸ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    function handleAllCoins(data) {
        coinsData = data; // ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸
        applyFilter(); // í˜„ì¬ í•„í„° ìƒíƒœì— ë”°ë¼ ë Œë”ë§
    }


    // ê¸‰ë“± ì½”ì¸ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    function handlePriceSurge(data) {
        const container = document.getElementById("notification-container");

        data.forEach((coin) => {
            // ì•Œë¦¼ ìƒì„±
            const notification = document.createElement("div");
            notification.className = "notification";

            // ì•Œë¦¼ ë‚´ìš©
            notification.innerHTML = `
            ğŸš€ <strong>${coin.market}</strong>: ${coin.name}<br>
            ê¸‰ë“±ë¥ : <span style="color: red; font-size: 18px;">${coin.changeRate}%</span><br>
            <small>ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•˜ì„¸ìš”!</small>
        `;

            // ì•Œë¦¼ ì¶”ê°€
            container.appendChild(notification);

            // ì¼ì • ì‹œê°„ í›„ ì•Œë¦¼ ì œê±° (í˜ì´ë“œ ì•„ì›ƒ ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
            setTimeout(() => {
                notification.classList.add("fade-out");
                setTimeout(() => notification.remove(), 500); // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
            }, 10000); // 10ì´ˆ í›„ ì œê±°
        });
    }


    // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ë… ë°ì´í„° API ìš”ì²­
    async function fetchSubscribedMarkets() {
        try {
            const response = await fetch("http://localhost:8082/api/subscriptions"); // API URL
            if (!response.ok) throw new Error("êµ¬ë… ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨");
            const data = await response.json(); // ì‘ë‹µ ë°ì´í„° ì „ì²´ ê°€ì ¸ì˜¤ê¸°

            // markets ë°°ì—´ ì¶”ì¶œ
            if (data && Array.isArray(data.markets)) {
                subscribedMarkets = data.markets; // markets ë°°ì—´ì„ subscribedMarketsì— ì €ì¥
            } else {
                console.error("API ì‘ë‹µì— 'markets' ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤:", data);
                subscribedMarkets = []; // ê¸°ë³¸ê°’
            }

            applyFilter(); // í˜„ì¬ í•„í„° ìƒíƒœì— ë§ê²Œ ë Œë”ë§
        } catch (error) {
            console.error("êµ¬ë… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            subscribedMarkets = []; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
            applyFilter(); // ë¹ˆ ë°ì´í„°ë¡œ ë Œë”ë§
        }
    }




    // ì½”ì¸ í…Œì´ë¸” ë Œë”ë§
    function renderTable(data) {

        console.log("ë°ì´í„°ë°›ì€ê²ƒì„~", data);
        if (!Array.isArray(data)) {
            console.error("renderTableì— ì „ë‹¬ëœ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", data);
            data = [];
        }


        // ì •ë ¬ ì„¤ì •ì´ ì¡´ì¬í•˜ë©´ ë°ì´í„°ë¥¼ ì •ë ¬
        if (sortConfig.key) {
            data.sort((a, b) => {
                const valueA = a[sortConfig.key];
                const valueB = b[sortConfig.key];
                if (typeof valueA === "string") {
                    return sortConfig.direction === "asc"
                        ? valueA.localeCompare(valueB)
                        : valueB.localeCompare(valueA);
                } else {
                    return sortConfig.direction === "asc" ? valueA - valueB : valueB - valueA;
                }
            });
        }

        // í…Œì´ë¸” ë Œë”ë§
        coinList.innerHTML = data
            .map((coin) => {
                const isSubscribed = subscribedMarkets.includes(coin.market); // êµ¬ë… ì—¬ë¶€ í™•ì¸
                const starSymbol = isSubscribed ? "â˜…" : "â˜†";

                const currentPrice = coin.currentPrice;
                const changeRate = coin.changeRate;

                const changeClass = changeRate < 0 ? "negative" : "positive";
                const priceColor = changeRate < 0 ? "blue" : "red";

                let priceClass = "";
                if (previousPrices[coin.market] !== undefined) {
                    if (currentPrice > previousPrices[coin.market]) {
                        priceClass = "price-up";
                    } else if (currentPrice < previousPrices[coin.market]) {
                        priceClass = "price-down";
                    }
                }

                previousPrices[coin.market] = currentPrice;

                return `
                <tr class="coin-row" data-market="${coin.market}" id="${coin.market}">
                    <td>
                        <span class="star-symbol">${starSymbol}</span>
                    </td>

                     <td>
                        ${coin.market}<span class="subtext">${coin.name}</span>
                    </td>
                    <td class="${priceClass}" style="color: ${priceColor}">${currentPrice.toLocaleString()} KRW</td>
                    <td class="change ${changeClass}" style="color: ${priceColor}">${changeRate > 0 ? "+" : ""}${changeRate}%</td>
                    <td>${coin.tradeVolume24h.toLocaleString()} ë°±ë§Œì›</td>
                </tr>`
            })
            .join("");

        // ìƒìŠ¹/í•˜ë½ íš¨ê³¼ ì œê±°
        setTimeout(() => {
            document.querySelectorAll(".price-up, .price-down").forEach((cell) => {
                cell.classList.remove("price-up", "price-down");
            });
        }, 1000);
    }


    // í…Œì´ë¸” í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ (ì •ë ¬)
    document.querySelectorAll(".sortable").forEach((header) => {
        header.addEventListener("click", () => {
            const key = header.dataset.key;

            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === "asc" ? "desc" : "asc";
            } else {
                sortConfig.key = key;
                sortConfig.direction = "asc";
            }

            document.querySelectorAll(".sortable").forEach((el) => el.classList.remove("sort-asc", "sort-desc"));
            header.classList.add(sortConfig.direction === "asc" ? "sort-asc" : "sort-desc");

            applyFilter(); // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ì •ë ¬í•˜ì—¬ ë Œë”ë§
        });
    });


    fetchSubscribedMarkets(); // êµ¬ë… ë°ì´í„° ë¡œë“œ


    //í•„í„°ê´€ë ¨

    document.getElementById("filter-interest").addEventListener("click", () => {
        console.log("ê´€ì‹¬í•„í„° ëˆ„ë¦„")
        currentFilter = "interest"; // í•„í„° ìƒíƒœë¥¼ "interest"ë¡œ ì„¤ì •
        applyFilter(); // í•„í„° ì ìš©
    });

    document.getElementById("filter-all").addEventListener("click", () => {
        currentFilter = "all"; // í•„í„° ìƒíƒœë¥¼ "all"ë¡œ ì„¤ì •
        applyFilter(); // í•„í„° ì ìš©
    });

    document.getElementById("filter-owned").addEventListener("click", () => {
        console.log("ë³´ìœ  í•„í„° ëˆ„ë¦„");
        currentFilter = "owned"; // í•„í„° ìƒíƒœë¥¼ "owned"ë¡œ ì„¤ì •
        applyFilter(); // í•„í„° ì ìš©
    });

    function applyFilter() {
        let filteredData = coinsData;

        if (currentFilter === "interest") {
            filteredData = coinsData.filter((coin) => subscribedMarkets.includes(coin.market));
            console.log("ê´€ì‹¬ í•„í„° ë°ì´í„°:", filteredData); // í•„í„°ë§ëœ ë°ì´í„° ë¡œê·¸ ì¶œë ¥

        }


        renderTable(filteredData);
    }



    //ì½”ì¸ êµ¬ë… ê´€ë ¨ ë¡œì§ë“¤...


    // ë³„í‘œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.addEventListener("click", (event) => {
        if (event.target.classList.contains("star-symbol")) {

            const market = event.target.closest("tr").dataset.market;
            console.log("ë³„í‘œí´ë¦­í–ˆìŠˆ" + market);
            toggleSubscription(market, event.target);

            // toggleSubscription(market, event.target);
        }
    });


    /**
     * êµ¬ë… í† ê¸€ API í˜¸ì¶œ ë° UI ì—…ë°ì´íŠ¸
     * @param {string} market - ì½”ì¸ ë§ˆì¼“ ID (ì˜ˆ: BTC/KRW)
     * @param {HTMLElement} starElement - í´ë¦­í•œ ë³„ ì•„ì´ì½˜ ìš”ì†Œ
     */
    async function toggleSubscription(market, starElement) {
        try {

            const requestData ={
                market: market
            }

            //êµ¬ë… í† ê¸€ ìš”ì²­
            const response = await fetch(`http://localhost:8082/api/subscriptions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body:JSON.stringify(requestData),//ëˆ„ë¥¸ ì½”ì¸ì˜ ë§ˆì¼“ì •ë³´
            });

            // ì‘ë‹µ ë°ì´í„° í™•ì¸ (êµ¬ë… ì¶”ê°€ or ì‚­ì œ ì—¬ë¶€)
            if (!response.ok) throw new Error("êµ¬ë… ìš”ì²­ ì‹¤íŒ¨");

            await fetchSubscribedMarkets();//êµ¬ë…ì •ë³´ ê°±ì‹ 


        } catch (error) {
            console.error("êµ¬ë… ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    //ìº”í‹€ì°¨íŠ¸ ê´€ë ¨ ë¡œì§

    // âœ… ì½”ì¸ ëª©ë¡ í…Œì´ë¸”ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.getElementById("coin-list").addEventListener("click", function (event) {
        let targetRow = event.target.closest("tr"); // í´ë¦­ëœ í–‰ ì°¾ê¸°
        if (!targetRow) return; // í´ë¦­ëœ ìš”ì†Œê°€ í–‰ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ

        let market = targetRow.dataset.market; // í•´ë‹¹ ì½”ì¸ì˜ ë§ˆì¼“ ID ê°€ì ¸ì˜¤ê¸°
        if (!market) return; // ë§ˆì¼“ IDê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ

        console.log(`ğŸ“Œ ì„ íƒí•œ ì½”ì¸: ${market}`); // ì½˜ì†” í™•ì¸

        // ì„ íƒí•œ ì½”ì¸ì˜ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
        updateCandleChart(market);
    });


    // âœ… ì—…ë¹„íŠ¸ APIì—ì„œ íŠ¹ì • ë§ˆì¼“ì˜ ìº”ë“¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchUpbitCandleData(market = "KRW-BTC", count = 30) {
        const url = `https://api.upbit.com/v1/candles/days?market=${market}&count=${count}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.map(candle => ({
                x: new Date(candle.candle_date_time_kst), // ë‚ ì§œ (í•œêµ­ì‹œê°„)
                o: candle.opening_price, // ì‹œê°€
                h: candle.high_price,    // ê³ ê°€
                l: candle.low_price,     // ì €ê°€
                c: candle.trade_price    // ì¢…ê°€
            })).reverse(); // ìµœì‹  ë°ì´í„°ê°€ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ë„ë¡ ì •ë ¬
        } catch (error) {
            console.error("ì—…ë¹„íŠ¸ API ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error);
            return [];
        }
    }

    // âœ… ì„ íƒí•œ ì½”ì¸ì˜ ìº”ë“¤ì°¨íŠ¸ ì •ë³´ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
    async function updateCandleChart(market) {
        const candleData = await fetchUpbitCandleData(market, 30); // ìƒˆë¡œìš´ ë°ì´í„° ìš”ì²­
        if (candleData.length === 0) {
            console.warn("ê°€ì ¸ì˜¨ ìº”ë“¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        console.log(`ğŸ“Š ${market} ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì¤‘...`, candleData);

        // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        if (window.coinChart) {
            window.coinChart.data.datasets[0].data = candleData;
            window.coinChart.data.datasets[0].label = `${market} ê°€ê²©`; // âœ… label ì—…ë°ì´íŠ¸
            window.coinChart.options.plugins.title.text = `${market} ìº”ë“¤ì°¨íŠ¸`; // ì°¨íŠ¸ ì œëª© ë³€ê²½
            window.coinChart.update();
        } else {
            createCandleChart(market); // ì°¨íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        }
    }


    // âœ… ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
    // âœ… ìº”ë“¤ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ (ì²˜ìŒ 1íšŒ ì‹¤í–‰)
    async function createCandleChart(market = "KRW-BTC") {
        const ctx = document.getElementById("coinChart").getContext("2d");
        const candleData = await fetchUpbitCandleData(market, 30);

        console.log(`ğŸ“Š ${market} ì´ˆê¸° ì°¨íŠ¸ ë°ì´í„°`, candleData);

        window.coinChart = new Chart(ctx, {
            type: "candlestick",
            data: {
                datasets: [{
                    label: `${market} ê°€ê²©`,
                    data: candleData,
                    borderColor: "black",
                    backgroundColor: "rgba(0, 0, 0, 0.1)",
                    color: {
                        up: "green",
                        down: "red",
                        unchanged: "gray"
                    },
                    barThickness: 10,
                    maxBarThickness: 15
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: `${market} ìº”ë“¤ì°¨íŠ¸` // ì°¨íŠ¸ ì œëª©
                    }
                },
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "day",
                            displayFormats: {
                                day: "yyyy-MM-dd" // âœ… ë‚ ì§œ í¬ë§· ì„¤ì •
                            },
                            tooltipFormat: "yyyy-MM-dd" // âœ… íˆ´íŒì—ë„ ë‚ ì§œ í‘œì‹œ
                        },

                        title: {
                            display: true,
                            text: "ë‚ ì§œ" // âœ… xì¶• ì œëª© ì¶”ê°€
                        },

                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì°¨íŠ¸ ìƒì„±, ë¹„íŠ¸ì½”ì¸
    document.addEventListener("DOMContentLoaded", () => createCandleChart("KRW-BTC"));




    //ë¡œê·¸ì¸í˜ì´ì§€ì´ë™ë¡œì§
    function redirectToLogin() {
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = "/api/login"; // ì‹¤ì œ ì†Œì…œ ë¡œê·¸ì¸ ì„ íƒ í˜ì´ì§€ URLë¡œ ë³€ê²½í•˜ì„¸ìš”
    }

</script>

</body>
</html>
